# Check that everything (tests, benches, etc) builds in std environments
precheck_steps: &precheck_steps
  docker:
    - image: circleci/rust:latest
  steps:
    - checkout
    - restore_cache:
        key: v1-embedded-graphics-{{ checksum "Cargo.lock" }}
    - run: rustup default ${RUST_VERSION:-stable}
    - run: rustup component add rustfmt
    - run: ./build.sh
    - save_cache:
        key: v1-embedded-graphics-{{ checksum "Cargo.lock" }}
        paths:
          - ./target
          - /home/ubuntu/.cargo

# Build crates for embedded target
target_steps: &target_steps
  docker:
    - image: circleci/rust:latest
  steps:
    - checkout
    - restore_cache:
        keys:
          - v1-embedded-graphics-{{ checksum "Cargo.lock" }}
          - v1-embedded-graphics-{{ checksum "Cargo.lock" }}-{{ .Environment.TARGET }}
    - run: |
        SYSROOT=$(rustc --print sysroot)

        if [[ ! "$SYSROOT" =~ "$TARGET" ]]; then
          rustup target add $TARGET
        else
          echo "Target $TARGET is already installed"
        fi
    - run: ./build_target.sh
    - run: ./build_target.sh --release
    - save_cache:
        keys:
          - v1-embedded-graphics-{{ checksum "Cargo.lock" }}
          - v1-embedded-graphics-{{ checksum "Cargo.lock" }}-{{ .Environment.TARGET }}

version: 2
jobs:
  precheck-stable:
    <<: *precheck_steps
  precheck-beta:
    environment:
      - RUST_VERSION: 'beta'
    <<: *precheck_steps
  precheck-nightly:
    environment:
      - RUST_VERSION: 'nightly'
    <<: *precheck_steps

  target-arm-unknown-linux-eabi:
    environment:
      - TARGET: 'arm-unknown-linux-eabi'
    <<: *target_steps

  target-armv7-unknown-linux-gnueabihf:
    environment:
      - TARGET: 'armv7-unknown-linux-gnueabihf'
    <<: *target_steps

  target-x86_64-unknown-linux-gnu:
    environment:
      - TARGET: 'x86_64-unknown-linux-gnu'
    <<: *target_steps

  target-x86_64-unknown-linux-musl:
    environment:
      - TARGET: 'x86_64-unknown-linux-musl'
    <<: *target_steps

  target-thumbv6m-none-eabi:
    environment:
      - TARGET: 'thumbv6m-none-eabi'
    <<: *target_steps

  target-thumbv7em-none-eabi:
    environment:
      - TARGET: 'thumbv7em-none-eabi'
    <<: *target_steps

  target-thumbv7em-none-eabihf:
    environment:
      - TARGET: 'thumbv7em-none-eabihf'
    <<: *target_steps

  target-thumbv7m-none-eabi:
    environment:
      - TARGET: 'thumbv7m-none-eabi'
    <<: *target_steps

workflows:
  version: 2
  build_all:
    jobs:
        - precheck-stable
        - precheck-beta
        - precheck-nightly

        - precheck-all:
            requires:
              - precheck-stable
              - precheck-beta
              - precheck-nightly

        # Raspberry Pi 1
        - target-arm-unknown-linux-eabi:
            requires:
              - precheck-all

        # Raspberry Pi 2, 3, etc
        - target-armv7-unknown-linux-gnueabihf:
            requires:
              - precheck-all

        # Linux
        - target-x86_64-unknown-linux-gnu:
            requires:
              - precheck-all
        - target-x86_64-unknown-linux-musl:
            requires:
              - precheck-all

        # Bare metal
        - target-thumbv6m-none-eabi:
            requires:
              - precheck-all
        - target-thumbv7em-none-eabi:
            requires:
              - precheck-all
        - target-thumbv7em-none-eabihf:
            requires:
              - precheck-all
        - target-thumbv7m-none-eabi:
            requires:
              - precheck-all
